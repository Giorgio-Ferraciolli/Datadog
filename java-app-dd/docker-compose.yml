services:

  # ── Datadog Agent ────────────────────────────────────────────────────────────
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: datadog-agent
    environment:
      DD_API_KEY: ${DD_API_KEY}
      DD_APM_ENABLED: "true"
      DD_APM_NON_LOCAL_TRAFFIC: "true"
      DD_LOGS_ENABLED: "true"
      DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL: "true"
      DD_SITE: "datadoghq.com"
      DD_ENV: "production"
      DD_HOSTNAME: "docker-host"
    volumes:
      - //var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "8126:8126/tcp"   # APM Trace Agent
    networks:
      - app-network

  # ── Java Application ─────────────────────────────────────────────────────────
  java-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: java-datadog-app
    depends_on:
      - datadog-agent
    environment:
      APP_ENV: production
      DD_AGENT_HOST: datadog-agent
      DD_SERVICE: java-datadog-app
      DD_ENV: production
      DD_VERSION: "1.0.0"
      DD_LOGS_INJECTION: "true"
      DD_TRACE_SAMPLE_RATE: "1"
    ports:
      - "8080:8080"
    labels:
      com.datadoghq.ad.logs: '[{"source": "java", "service": "java-datadog-app"}]'
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

  # ── Frontend ─────────────────────────────────────────────────────────────────
  frontend:
    image: nginx:alpine
    container_name: java-datadog-frontend
    depends_on:
      - java-app
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "3000:80"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
