version: "3.8"

services:

  #############################################################
  # ORACLE XE DATABASE
  #############################################################
  oracle-xe:
    image: gvenzl/oracle-xe:21-slim
    container_name: oracle-xe

    restart: unless-stopped

    ports:
      - "${ORACLE_PORT}:1521"

    environment:
      # Senha do SYS/SYSTEM
      ORACLE_PASSWORD: ${ORACLE_PASSWORD}

      # Service Name padrão
      ORACLE_DATABASE: ${ORACLE_SERVICE}

    volumes:
      # Scripts executados automaticamente na primeira inicialização
      - ./oracle/init:/container-entrypoint-initdb.d

    networks:
      - datadog-net


  #############################################################
  # DATADOG AGENT
  #############################################################
  datadog-agent:
    image: datadog/agent:latest
    container_name: datadog-agent

    restart: unless-stopped

    depends_on:
      - oracle-xe

    environment:
      #########################################################
      # CONFIGURAÇÃO DATADOG
      #########################################################

      DD_API_KEY: ${DATADOG_API_KEY}
      DD_SITE: ${DATADOG_SITE}

      # Habilita Database Monitoring
      DD_DATABASE_MONITORING_ENABLED: "true"

      # Tags globais
      DD_ENV: ${ENVIRONMENT}
      DD_TAGS: "project:${PROJECT}"

      #########################################################
      # CONFIGURAÇÃO ORACLE
      #########################################################

      ORACLE_HOST: ${ORACLE_HOST}
      ORACLE_PORT: ${ORACLE_PORT}
      ORACLE_SERVICE: ${ORACLE_SERVICE}
      ORACLE_USER: ${ORACLE_USER}
      ORACLE_PASSWORD: ${ORACLE_PASSWORD}

    volumes:

      #########################################################
      # Configuração principal do Agent
      #########################################################
      - ./datadog/datadog.yaml:/etc/datadog-agent/datadog.yaml

      #########################################################
      # Configuração da integração Oracle
      #########################################################
      - ./datadog/conf.d/oracle.d/conf.yaml:/etc/datadog-agent/conf.d/oracle.d/conf.yaml

      #########################################################
      # Docker socket (necessário para container monitoring)
      #########################################################
      - /var/run/docker.sock:/var/run/docker.sock:ro

      #########################################################
      # Proc filesystem (melhor coleta de métricas)
      #########################################################
      - /proc:/host/proc:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro

    networks:
      - datadog-net


#############################################################
# NETWORK
#############################################################
networks:
  datadog-net:
    driver: bridge

